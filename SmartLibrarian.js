require('dotenv').config();
const OpenAI = require('openai');
const Chats = require('./models/Chats');
const BookController = require('./controller/BookController');

class SmartLibrarian {
    constructor() {
        this.openai = new OpenAI({
            apiKey: process.env.OPENAI_API_KEY
        });

        this.systemPrompt = {
            role: "system",
            content: `–í—ã - —É–º–Ω—ã–π –±–∏–±–ª–∏–æ—Ç–µ—á–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –†–µ—Å–ø—É–±–ª–∏–∫–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω. –í–∞—à–∞ –∑–∞–¥–∞—á–∞ - –ø–æ–º–æ–≥–∞—Ç—å –∏—Å–∫–∞—Ç—å –∫–Ω–∏–≥–∏ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ.
        
        –í–ê–ñ–ù–û –û –ü–û–ò–°–ö–ï –ö–ù–ò–ì:
        1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞
        2. –ù–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –≤ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å–ª–æ–≤–∞ "–¥–∏—Å—Å–µ—Ä—Ç–∞—Ü–∏—è", "—Ä–µ—Ñ–µ—Ä–∞—Ç", "–∫–Ω–∏–≥–∞" –∏ —Ç.–ø.
        3. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–ª–æ–≤–∞ –≤ –ø–æ–∏—Å–∫–æ–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ
        4. –ò—â–∏—Ç–µ —Ç–æ–ª—å–∫–æ –ø–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–º–µ, –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–ø–æ–º–∏–Ω–∞–µ—Ç –≤–∏–¥ —Ä–∞–±–æ—Ç—ã
        
        –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –æ –ö–ù–ò–ì–ê–•:
        - "–ù—É–∂–Ω—ã –∫–Ω–∏–≥–∏ –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ –¥–ª—è –¥–∏—Å—Å–µ—Ä—Ç–∞—Ü–∏–∏" ‚Üí searchBooks({query: "–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞"})
        - "–ü–∏—à—É —Ä–µ—Ñ–µ—Ä–∞—Ç –æ –∫–≤–∞–Ω—Ç–æ–≤–æ–π —Ñ–∏–∑–∏–∫–µ" ‚Üí searchBooks({query: "–∫–≤–∞–Ω—Ç–æ–≤–∞—è —Ñ–∏–∑–∏–∫–∞"})
        - "–ú–Ω–µ –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞" ‚Üí searchBooks({query: "–∏—Å—Ç–æ—Ä–∏—è –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω"})
        
        –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ë–ò–ë–õ–ò–û–¢–ï–ö–ï:
        - –ù–∞–∑–≤–∞–Ω–∏–µ: –ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –†–µ—Å–ø—É–±–ª–∏–∫–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω
        - –ê–¥—Ä–µ—Å: –≥. –ê—Å—Ç–∞–Ω–∞, —É–ª. –î–æ—Å—Ç—ã–∫, 11
        - –¢–µ–ª–µ—Ñ–æ–Ω: +7 (7172) 70-65-00
        - –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞: nabrk@nabrk.kz
        - –í–µ–±-—Å–∞–π—Ç: www.nabrk.kz
        
        –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã:
        - –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫-–ø—è—Ç–Ω–∏—Ü–∞: —Å 09:00 –¥–æ 20:00
        - –°—É–±–±–æ—Ç–∞: —Å 09:00 –¥–æ 18:00
        - –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ: –≤—ã—Ö–æ–¥–Ω–æ–π
        - –ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞: —Å–∞–Ω–∏—Ç–∞—Ä–Ω—ã–π –¥–µ–Ω—å
        
        –û—Å–Ω–æ–≤–Ω—ã–µ —É—Å–ª—É–≥–∏:
        - –î–æ—Å—Ç—É–ø –∫ –∫–Ω–∏–∂–Ω–æ–º—É —Ñ–æ–Ω–¥—É –∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–º —Ä–µ—Å—É—Ä—Å–∞–º
        - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –≤—ã–¥–∞—á–∞ —á–∏—Ç–∞—Ç–µ–ª—å—Å–∫–∏—Ö –±–∏–ª–µ—Ç–æ–≤
        - –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ –ø–æ–∏—Å–∫—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        - –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç –∏ –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤ —Å –¥–æ—Å—Ç—É–ø–æ–º –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
        - –ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –∫—É–ª—å—Ç—É—Ä–Ω—ã—Ö –∏ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
        
        –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–Ω—è—Ç–µ–Ω –∏ –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω - –°–†–ê–ó–£ –≤—ã–ø–æ–ª–Ω—è–π—Ç–µ –ø–æ–∏—Å–∫, –ù–ï –∑–∞–¥–∞–≤–∞–π—Ç–µ —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.
        
        –ó–∞–¥–∞–≤–∞–π—Ç–µ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –∑–∞–ø—Ä–æ—Å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ—è—Å–µ–Ω. –ù–∞–ø—Ä–∏–º–µ—Ä:
        - "–•–æ—á—É —Ö–æ—Ä–æ—à—É—é –∫–Ω–∏–≥—É" (—Å–ª–∏—à–∫–æ–º –æ–±—â–∏–π –∑–∞–ø—Ä–æ—Å)
        - "–ß—Ç–æ-–Ω–∏–±—É–¥—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ" (–Ω–µ–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ)
        - "–ê–±–∞–π" (–Ω–µ—è—Å–Ω–æ - –∞–≤—Ç–æ—Ä –∏–ª–∏ —Ç–µ–º–∞)
        
        –ü–û–ú–ù–ò–¢–ï: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç "–î–∞" –Ω–∞ –≤–∞—à–µ —É—Ç–æ—á–Ω–µ–Ω–∏–µ, –°–†–ê–ó–£ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∞–º–∏ —Ç–µ–º—ã –¥–ª—è –ø–æ–∏—Å–∫–∞.
        
        –í–ê–ñ–ù–û –û –ó–ê–ü–†–û–°–ê–• –ü–û–ú–û–©–ò:
        –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –ø–æ–º–æ—á—å –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç, —ç—Å—Å–µ, —Å–æ—á–∏–Ω–µ–Ω–∏–µ, —Ä–µ—Ñ–µ—Ä–∞—Ç –∏ —Ç.–ø., –ù–ï –≤—ã–ø–æ–ª–Ω—è–π—Ç–µ –ø–æ–∏—Å–∫ –∫–Ω–∏–≥, 
        –∞ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ —Å–≤–æ—é –ø–æ–º–æ—â—å –≤ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –ø–ª–∞–Ω–∞, —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏–ª–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ —Ç–µ–º–µ. –ü–æ—è—Å–Ω–∏—Ç–µ, —á—Ç–æ –≤—ã –º–æ–∂–µ—Ç–µ:
        1. –ü–æ–º–æ—á—å —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω —Ç–µ–∫—Å—Ç–∞
        2. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–∞–±–æ—Ç—ã
        3. –î–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é
        4. –û–±—ä—è—Å–Ω–∏—Ç—å, –∫–∞–∫ –ª—É—á—à–µ —Ä–∞—Å–∫—Ä—ã—Ç—å —Ç–µ–º—É
        5. –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏`
        };
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ
        this.libraryInfo = {
            general: {
                name: "–ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –†–µ—Å–ø—É–±–ª–∏–∫–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω",
                description: "–ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –†–µ—Å–ø—É–±–ª–∏–∫–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω (–ù–ê–ë –†–ö) –æ—Å–Ω–æ–≤–∞–Ω–∞ –≤ 2004 –≥–æ–¥—É –∏ —è–≤–ª—è–µ—Ç—Å—è –æ–¥–Ω–æ–π –∏–∑ –∫—Ä—É–ø–Ω–µ–π—à–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ —Å—Ç—Ä–∞–Ω—ã. –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ä–∞—Å–ø–æ–ª–∞–≥–∞–µ—Ç –æ–±—à–∏—Ä–Ω—ã–º —Ñ–æ–Ω–¥–æ–º –Ω–∞—É—á–Ω–æ–π, –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –∏ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —è–∑—ã–∫–∞—Ö.",
                mission: "–ú–∏—Å—Å–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ - —Å–æ–¥–µ–π—Å—Ç–≤–∏–µ —Ä–∞–∑–≤–∏—Ç–∏—é –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞ —Å—Ç—Ä–∞–Ω—ã —á–µ—Ä–µ–∑ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–Ω–∞–Ω–∏—è–º –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏."
            },
            
            contacts: {
                address: "–≥. –ê—Å—Ç–∞–Ω–∞, —É–ª. –î–æ—Å—Ç—ã–∫, 11",
                phone: "+7 (7172) 70-65-00",
                email: "nabrk@nabrk.kz",
                website: "www.nabrk.kz",
                socialMedia: {
                    facebook: "facebook.com/nabrkz",
                    instagram: "@nabrkastana",
                    telegram: "t.me/nabrkastana"
                }
            },
            
            hours: {
                weekdays: "—Å 09:00 –¥–æ 20:00 (–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫-–ü—è—Ç–Ω–∏—Ü–∞)",
                saturday: "—Å 09:00 –¥–æ 18:00",
                sunday: "–í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å",
                sanitaryDay: "–ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞ - —Å–∞–Ω–∏—Ç–∞—Ä–Ω—ã–π –¥–µ–Ω—å"
            },
            
            staff: [
                {
                    name: "–ú—É–Ω–∞–ª–±–∞–µ–≤–∞ –£.–î.",
                    position: "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä",
                    contact: "director@nabrk.kz"
                },
                {
                    name: "–ò—Å–∫–∞–ª–∏–µ–≤–∞ –ù.–ê.",
                    position: "–ó–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å –≥–µ–Ω–µ—Ä–∞–ª—å–Ω–æ–≥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞",
                    contact: "n.iskalieva@nabrk.kz"
                },
                {
                    name: "–ë–µ—Ä–¥–∏–≥–∞–ª–∏–µ–≤–∞ –†.–ê.",
                    position: "–ì–ª–∞–≤–Ω—ã–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä—å",
                    contact: "r.berdigalieva@nabrk.kz"
                }
            ],
            
            services: {
                general: [
                    "–î–æ—Å—Ç—É–ø –∫ –∫–Ω–∏–∂–Ω–æ–º—É —Ñ–æ–Ω–¥—É",
                    "–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥",
                    "–í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è —Å–ø—Ä–∞–≤–æ—á–Ω–∞—è —Å–ª—É–∂–±–∞",
                    "–ú–µ–∂–±–∏–±–ª–∏–æ—Ç–µ—á–Ω—ã–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç",
                    "Wi-Fi –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏"
                ],
                
                special: [
                    "–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∫—É–ª—å—Ç—É—Ä–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π",
                    "–í—ã—Å—Ç–∞–≤–∫–∏ –∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏",
                    "–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏ –ª–µ–∫—Ü–∏–∏",
                    "–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö",
                    "–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Ç—É—Ä—ã –ø–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ"
                ]
            },
            
            rules: {
                membership: "–î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è —á–∏—Ç–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –±–∏–ª–µ—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–µ–¥—ä—è–≤–∏—Ç—å —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏, —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é 3x4 –∏ –æ–ø–ª–∞—Ç–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –±–∏–ª–µ—Ç–∞ (2000 —Ç–≥).",
                borrowing: "–°—Ä–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–Ω–∏–≥–∞–º–∏ - 14 –¥–Ω–µ–π —Å –ø—Ä–∞–≤–æ–º –ø—Ä–æ–¥–ª–µ–Ω–∏—è, –µ—Å–ª–∏ –Ω–∞ –∏–∑–¥–∞–Ω–∏–µ –Ω–µ—Ç —Å–ø—Ä–æ—Å–∞ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –¥—Ä—É–≥–∏—Ö —á–∏—Ç–∞—Ç–µ–ª–µ–π.",
                conduct: "–í –±–∏–±–ª–∏–æ—Ç–µ–∫–µ –∑–∞–ø—Ä–µ—â–∞–µ—Ç—Å—è —à—É–º–µ—Ç—å, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–±–∏–ª—å–Ω—ã–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã –¥–ª—è —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤, –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ø–∏—â—É –≤ —á–∏—Ç–∞–ª—å–Ω—ã—Ö –∑–∞–ª–∞—Ö.",
                fees: "–®—Ç—Ä–∞—Ñ –∑–∞ –Ω–µ—Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –∫–Ω–∏–≥–∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 100 —Ç–≥ –∑–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø—Ä–æ—Å—Ä–æ—á–∫–∏."
            },
            
            collections: {
                size: "–§–æ–Ω–¥ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –Ω–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç –±–æ–ª–µ–µ 1,5 –º–∏–ª–ª–∏–æ–Ω–∞ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤",
                specialCollections: [
                    "–ö–æ–ª–ª–µ–∫—Ü–∏—è —Ä–µ–¥–∫–∏—Ö –∫–Ω–∏–≥",
                    "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è",
                    "–ù–∞—É—á–Ω–∞—è –ø–µ—Ä–∏–æ–¥–∏–∫–∞",
                    "–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞"
                ]
            }
        };
    }

    getLibraryInfo(params) {
        try {
            const topic = params?.topic || "general";
            const searchTerm = params?.searchTerm || "";
            
            // –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö
            if (topic === "staff") {
                if (searchTerm) {
                    // –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
                    const foundStaff = this.libraryInfo.staff.filter(person => 
                        person.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        person.position.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                    
                    if (foundStaff.length > 0) {
                        return {
                            found: true,
                            data: foundStaff,
                            message: `–ù–∞–π–¥–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ ${foundStaff.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö.`
                        };
                    } else {
                        return {
                            found: false,
                            message: `–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å –∏–º–µ–Ω–µ–º –∏–ª–∏ –¥–æ–ª–∂–Ω–æ—Å—Ç—å—é "${searchTerm}" –Ω–µ –Ω–∞–π–¥–µ–Ω.`
                        };
                    }
                } else {
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                    return {
                        found: true,
                        data: this.libraryInfo.staff,
                        message: `–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.`
                    };
                }
            }
            
            // –ü–æ–∏—Å–∫ –æ–±—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ
            if (topic === "general") {
                return {
                    found: true,
                    data: this.libraryInfo.general,
                    message: "–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ."
                };
            }
            
            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Å–∞—Ö —Ä–∞–±–æ—Ç—ã
            if (topic === "hours") {
                return {
                    found: true,
                    data: this.libraryInfo.hours,
                    message: "–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã –±–∏–±–ª–∏–æ—Ç–µ–∫–∏."
                };
            }
            
            // –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            if (topic === "contacts") {
                return {
                    found: true,
                    data: this.libraryInfo.contacts,
                    message: "–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏."
                };
            }
            
            // –ü—Ä–∞–≤–∏–ª–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
            if (topic === "rules") {
                return {
                    found: true,
                    data: this.libraryInfo.rules,
                    message: "–ü—Ä–∞–≤–∏–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π."
                };
            }
            
            // –£—Å–ª—É–≥–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
            if (topic === "services") {
                return {
                    found: true,
                    data: this.libraryInfo.services,
                    message: "–£—Å–ª—É–≥–∏, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π."
                };
            }
            
            // –ö–æ–ª–ª–µ–∫—Ü–∏–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
            if (topic === "collections") {
                return {
                    found: true,
                    data: this.libraryInfo.collections,
                    message: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–ª–ª–µ–∫—Ü–∏—è—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫–∏."
                };
            }
            
            // –ï—Å–ª–∏ —Ç–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
            return {
                found: false,
                message: `–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —Ç–µ–º–µ "${topic}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.`
            };
            
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ:", error);
            return {
                found: false,
                error: true,
                message: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ."
            };
        }
    }

    async analyzeRequest(message) {
        try {
            // –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
            const simpleGreetings = [
                "–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ", "–¥–æ–±—Ä—ã–π –¥–µ–Ω—å", "–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä", "–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ", 
                "–∑–¥—Ä–∞—Å—å—Ç–µ", "–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é", "—Å”ô–ª–µ–º", "—Å–∞–ª–µ–º", "“õ–∞–π—ã—Ä–ª—ã —Ç–∞“£", "“õ–∞–π—ã—Ä–ª—ã –∫“Ø–Ω", 
                "“õ–∞–π—ã—Ä–ª—ã –∫–µ—à", "–∫–∞–∫ –¥–µ–ª–∞", "–∫–∞–∫ —Ç—ã", "–∫–∞–∫ –≤—ã"
            ];
            
            // –ú–∞—Ä–∫–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –æ –ø–æ–º–æ—â–∏ –≤ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞
            const helpWithWritingMarkers = [
                "–ø–æ–º–æ–≥–∏ –Ω–∞–ø–∏—Å–∞—Ç—å", "–ø–æ–º–æ–≥–∏ —Å –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º", "–∫–∞–∫ –Ω–∞–ø–∏—Å–∞—Ç—å", 
                "–Ω–∞–ø–∏—à–∏ –¥–ª—è –º–µ–Ω—è", "–Ω–∞–ø–∏—à–∏ –º–Ω–µ", "–ø–æ–º–æ–≥–∏ —Å–æ—Å—Ç–∞–≤–∏—Ç—å",
                "—Å–æ—á–∏–Ω–∏ –¥–ª—è –º–µ–Ω—è", "—Å–æ—Å—Ç–∞–≤—å –¥–ª—è –º–µ–Ω—è", "—Å–¥–µ–ª–∞–π –∑–∞ –º–µ–Ω—è", 
                "–∫–∞–∫ —Å–æ—Å—Ç–∞–≤–∏—Ç—å", "–∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å –¥–æ–∫–ª–∞–¥", "–∫–∞–∫ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —ç—Å—Å–µ"
            ];
            
            // –ú–∞—Ä–∫–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –æ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ
            const libraryInfoMarkers = [
                "–±–∏–±–ª–∏–æ—Ç–µ–∫–∞", "—Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã", "—á–∞—Å—ã —Ä–∞–±–æ—Ç—ã", "–≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã",
                "–∞–¥—Ä–µ—Å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏", "–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è", "–∫–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è", "–∫–æ–Ω—Ç–∞–∫—Ç—ã",
                "—Ç–µ–ª–µ—Ñ–æ–Ω –±–∏–±–ª–∏–æ—Ç–µ–∫–∏", "–ø–æ—á—Ç–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏", "—Å–∞–π—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏",
                "–ø—Ä–∞–≤–∏–ª–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏", "–∫–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "—á–∏—Ç–∞—Ç–µ–ª—å—Å–∫–∏–π –±–∏–ª–µ—Ç",
                "—É—Å–ª—É–≥–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏", "–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è", "–≤—ã—Å—Ç–∞–≤–∫–∏", "—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏",
                "—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏", "–¥–∏—Ä–µ–∫—Ç–æ—Ä –±–∏–±–ª–∏–æ—Ç–µ–∫–∏", "–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ"
            ];
            
            const normalizedMessage = message.toLowerCase().trim();
            
            // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ä–∞–∑—É –∫–∞–∫ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
            if (simpleGreetings.includes(normalizedMessage) || 
                simpleGreetings.some(greeting => normalizedMessage.startsWith(greeting + " ")) ||
                normalizedMessage.length < 15) {
                    
                return {
                    requestType: "greeting",
                    confidence: 100,
                    topic: "–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ",
                    suggestedFunction: null
                };
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å–æ–º –æ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ
            if (libraryInfoMarkers.some(marker => normalizedMessage.includes(marker))) {
                let topic = "general";
                
                if (normalizedMessage.includes("—á–∞—Å—ã") || normalizedMessage.includes("—Ä–µ–∂–∏–º") || normalizedMessage.includes("–≥—Ä–∞—Ñ–∏–∫") || 
                    normalizedMessage.includes("–∫–æ–≥–¥–∞") || normalizedMessage.includes("—Ä–∞–±–æ—Ç–∞–µ—Ç")) {
                    topic = "hours";
                } else if (normalizedMessage.includes("–∞–¥—Ä–µ—Å") || normalizedMessage.includes("–∫–æ–Ω—Ç–∞–∫—Ç") || 
                           normalizedMessage.includes("—Ç–µ–ª–µ—Ñ–æ–Ω") || normalizedMessage.includes("–ø–æ—á—Ç–∞") || 
                           normalizedMessage.includes("—Å–∞–π—Ç") || normalizedMessage.includes("–≥–¥–µ –Ω–∞—Ö–æ–¥")) {
                    topic = "contacts";
                } else if (normalizedMessage.includes("–ø—Ä–∞–≤–∏–ª") || normalizedMessage.includes("–∑–∞–ø–∏—Å") || 
                           normalizedMessage.includes("–±–∏–ª–µ—Ç") || normalizedMessage.includes("–∫–∞–∫ –ø–æ–ª—å–∑")) {
                    topic = "rules";
                } else if (normalizedMessage.includes("—É—Å–ª—É–≥") || normalizedMessage.includes("—Å–µ—Ä–≤–∏—Å") || 
                           normalizedMessage.includes("—á—Ç–æ –ø—Ä–µ–¥–ª–∞–≥") || normalizedMessage.includes("–º–µ—Ä–æ–ø—Ä–∏—è—Ç") || 
                           normalizedMessage.includes("–≤—ã—Å—Ç–∞–≤–∫")) {
                    topic = "services";
                } else if (normalizedMessage.includes("—Å–æ—Ç—Ä—É–¥–Ω–∏–∫") || normalizedMessage.includes("–¥–∏—Ä–µ–∫—Ç–æ—Ä") || 
                           normalizedMessage.includes("—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤") || normalizedMessage.includes("–ø–µ—Ä—Å–æ–Ω–∞–ª") || 
                           normalizedMessage.includes("—Ä–∞–±–æ—Ç–Ω–∏–∫")) {
                    topic = "staff";
                } else if (normalizedMessage.includes("–∫–æ–ª–ª–µ–∫—Ü") || normalizedMessage.includes("—Ñ–æ–Ω–¥") || 
                           normalizedMessage.includes("–∫–Ω–∏–≥") || normalizedMessage.includes("—ç–∫–∑–µ–º–ø–ª—è—Ä")) {
                    topic = "collections";
                }
                
                return {
                    requestType: "library_info",
                    confidence: 90,
                    topic: topic,
                    suggestedFunction: {
                        name: "getLibraryInfo",
                        params: {
                            topic: topic,
                            searchTerm: normalizedMessage
                        }
                    }
                };
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å–æ–º –æ –ø–æ–º–æ—â–∏ –≤ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞
            if (helpWithWritingMarkers.some(marker => normalizedMessage.includes(marker))) {
                return {
                    requestType: "writing_help",
                    confidence: 90,
                    topic: "–ø–æ–º–æ—â—å –≤ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏",
                    suggestedFunction: null
                };
            }
            
            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞ —Å –ø–æ–º–æ—â—å—é –ø—Ä–æ—Å—Ç—ã—Ö –ø—Ä–∞–≤–∏–ª,
            // –∏—Å–ø–æ–ª—å–∑—É–µ–º GPT –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–∞
            if (message.length > 10) {
                try {
                    const classification = await this.classifyRequestWithGPT(message);
                    return classification;
                } catch (classificationError) {
                    console.error('–û—à–∏–±–∫–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–∞ —Å –ø–æ–º–æ—â—å—é GPT:', classificationError);
                    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –±–∞–∑–æ–≤—ã–º –∞–Ω–∞–ª–∏–∑–æ–º
                }
            }
            
            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫–∞–∫ –ø–æ–∏—Å–∫ –∫–Ω–∏–≥
            return {
                requestType: "books",
                confidence: 80,
                topic: "–ø–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É",
                suggestedFunction: {
                    name: "searchBooks",
                    params: this.extractBookParams(message)
                }
            };
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–∏—Å–∫ –ø–æ –∫–Ω–∏–≥–∞–º –ø—Ä–∏ –æ—à–∏–±–∫–µ
            return {
                requestType: "books",
                confidence: 50,
                topic: "–ø–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É",
                suggestedFunction: {
                    name: "searchBooks",
                    params: {
                        author: null,
                        title: null,
                        query: message
                    }
                }
            };
        }
    }
    
    // –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ —Å –ø–æ–º–æ—â—å—é GPT
    async classifyRequestWithGPT(message) {
        try {
            console.log('üîç –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å —Å –ø–æ–º–æ—â—å—é GPT:', message);
            
            const completion = await this.openai.chat.completions.create({
                model: "gpt-4o-mini",
                messages: [
                    {
                        role: "system",
                        content: `–¢—ã - –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ—á–Ω–æ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞. 
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–í–æ–∑–º–æ–∂–Ω—ã–µ —Ç–∏–ø—ã –∑–∞–ø—Ä–æ—Å–æ–≤:
1. greeting - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –Ω–µ —Ç—Ä–µ–±—É—é—â–µ–µ –ø–æ–∏—Å–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
2. books - –∑–∞–ø—Ä–æ—Å –æ –ø–æ–∏—Å–∫–µ –∫–Ω–∏–≥ (–ø–æ –∞–≤—Ç–æ—Ä—É, –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ —Ç–µ–º–µ)
3. writing_help - –∑–∞–ø—Ä–æ—Å –æ –ø–æ–º–æ—â–∏ –≤ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞, —ç—Å—Å–µ, —Ä–µ—Ñ–µ—Ä–∞—Ç–∞ –∏ —Ç.–ø.
4. library_info - –∑–∞–ø—Ä–æ—Å –æ–± –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ (—Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã, –∞–¥—Ä–µ—Å, —É—Å–ª—É–≥–∏ –∏ —Ç.–¥.)

–í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ:
{
    "requestType": "books" | "greeting" | "writing_help" | "library_info",
    "confidence": —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 100,
    "topic": "–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–º—ã –∑–∞–ø—Ä–æ—Å–∞",
    "suggestedFunction": null –∏–ª–∏ { "name": "searchBooks", "params": { "author": "–∏–º—è –∞–≤—Ç–æ—Ä–∞ –∏–ª–∏ null", "title": "–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ –∏–ª–∏ null", "query": "–ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏–ª–∏ null" } } –∏–ª–∏ { "name": "getLibraryInfo", "params": { "topic": "general" | "hours" | "contacts" | "rules" | "services" | "staff" | "collections", "searchTerm": "—Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –∏–ª–∏ null" } }
}

–ü—Ä–∏–º–µ—Ä—ã:
–ó–∞–ø—Ä–æ—Å: "–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?"
–û—Ç–≤–µ—Ç: { "requestType": "greeting", "confidence": 100, "topic": "–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ", "suggestedFunction": null }

–ó–∞–ø—Ä–æ—Å: "–ú–Ω–µ –Ω—É–∂–Ω—ã –∫–Ω–∏–≥–∏ –ø–æ –∫–≤–∞–Ω—Ç–æ–≤–æ–π —Ñ–∏–∑–∏–∫–µ"
–û—Ç–≤–µ—Ç: { "requestType": "books", "confidence": 95, "topic": "–ø–æ–∏—Å–∫ –∫–Ω–∏–≥ –ø–æ —Ñ–∏–∑–∏–∫–µ", "suggestedFunction": { "name": "searchBooks", "params": { "author": null, "title": null, "query": "–∫–≤–∞–Ω—Ç–æ–≤–∞—è —Ñ–∏–∑–∏–∫–∞" } } }

–ó–∞–ø—Ä–æ—Å: "–ö–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∞?"
–û—Ç–≤–µ—Ç: { "requestType": "library_info", "confidence": 95, "topic": "—Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã", "suggestedFunction": { "name": "getLibraryInfo", "params": { "topic": "hours", "searchTerm": "–∫–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∞" } } }

–ó–∞–ø—Ä–æ—Å: "–ü–æ–º–æ–≥–∏ –º–Ω–µ –Ω–∞–ø–∏—Å–∞—Ç—å —ç—Å—Å–µ –æ –≤–ª–∏—è–Ω–∏–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π"
–û—Ç–≤–µ—Ç: { "requestType": "writing_help", "confidence": 90, "topic": "–ø–æ–º–æ—â—å —Å —ç—Å—Å–µ", "suggestedFunction": null }`
                    },
                    {
                        role: "user",
                        content: message
                    }
                ],
                temperature: 0.1,
                max_tokens: 500
            });
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏ –ø–∞—Ä—Å–∏–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            try {
                const result = JSON.parse(completion.choices[0].message.content);
                console.log('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏:', result);
                return result;
            } catch (parseError) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ GPT:', parseError);
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç GPT');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–∞:', error);
            throw error;
        }
    }
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–ø—Ä–æ—Å–∞
    extractBookParams(message) {
        const params = {
            author: null,
            title: null,
            query: null
        };
        
        // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∞–≤—Ç–æ—Ä–∞
        const authorMatch = message.match(/(?:–∞–≤—Ç–æ—Ä|–ø–∏—Å–∞—Ç[–∞-—è]+)[^–∞-—è]+([\p{L}\s\d\-]+)/ui);
        if (authorMatch && authorMatch[1]) {
            params.author = authorMatch[1].trim();
        }
        
        // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏
        const titleMatch = message.match(/(?:–Ω–∞–∑–≤–∞–Ω–∏–µ|–∫–Ω–∏–≥[–∞-—è]+)[^–∞-—è]+"([^"]+)"/ui);
        if (titleMatch && titleMatch[1]) {
            params.title = titleMatch[1].trim();
        }
        
        // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –∞–≤—Ç–æ—Ä–∞ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π –∑–∞–ø—Ä–æ—Å
        if (!params.author && !params.title) {
            // –£–¥–∞–ª—è–µ–º —Å–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –Ω—É–∂–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞
            let cleanedMessage = message.replace(/–Ω–∞–π—Ç–∏|–∫–Ω–∏–≥–∏|–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞|–ø–æ|–∞–≤—Ç–æ—Ä|–Ω–∞–∑–≤–∞–Ω–∏–µ|–æ|–¥–∞–π|–ø–æ–∂–∞–ª—É–π—Å—Ç–∞|–º–Ω–µ|–Ω—É–∂–Ω—ã|–Ω—É–∂–Ω–∞|–¥–ª—è/gi, ' ');
            cleanedMessage = cleanedMessage.replace(/\s+/g, ' ').trim();
            
            if (cleanedMessage && cleanedMessage.length > 2) {
                params.query = cleanedMessage;
            }
        }
        
        return params;
    }

    async chat(message, token) {
        try {
            console.log('\n======= –ù–û–í–´–ô –ó–ê–ü–†–û–° –ß–ê–¢–ê =======');
            console.log('üìù –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', message);
            console.log('üîë –¢–æ–∫–µ–Ω:', token);

            // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
            const previousMessages = await Chats.findAll({
                where: { token: token || 0 },
                order: [['createdAt', 'DESC']],
                limit: 10
            });

            console.log('üìö –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π):');
            const formattedMessages = previousMessages.reverse();
            formattedMessages.forEach((msg, index) => {
                console.log(`   ${index + 1}. ${msg.role}: ${msg.text}`);
            });

            // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            console.log('üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
            const requestAnalysis = await this.analyzeRequest(message);
            console.log('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞:', requestAnalysis);
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è GPT
            const context = formattedMessages.map(msg => ({
                role: msg.role,
                content: msg.text
            }));

            console.log('\nüß† –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ GPT...');

            // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –Ω–∞–ø—Ä—è–º—É—é –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ–≥–æ
            if (requestAnalysis.requestType === "greeting") {
                console.log(`üëã –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é`);
                
                // –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
                let systemPromptContent = `–¢—ã - –±–∏–±–ª–∏–æ—Ç–µ—á–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.
                    
–û—Ç–≤–µ—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–º, –∂–∏–≤—ã–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º. –£–ø–æ–º—è–Ω–∏, —á—Ç–æ –º–æ–∂–µ—à—å –ø–æ–º–æ—á—å —Å –ø–æ–∏—Å–∫–æ–º –∫–Ω–∏–≥, –Ω–æ –¥–µ–ª–∞–π —ç—Ç–æ –ï–°–¢–ï–°–¢–í–ï–ù–ù–û, –∫–∞–∫ –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫.
–ù–∏–∫–∞–∫–∏—Ö —à–∞–±–ª–æ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑ –∏ —Ñ–æ—Ä–º–∞–ª—å–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.

–ì–æ–≤–æ—Ä–∏ –Ω–∞ —Ç–æ–º –∂–µ —è–∑—ã–∫–µ, —á—Ç–æ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.`;
                
                const completionResponse = await this.openai.chat.completions.create({
                    model: "gpt-4o-mini",
                    messages: [
                        { role: "system", content: systemPromptContent },
                        ...context,
                        { role: 'user', content: message }
                    ],
                    temperature: 0.7,
                    max_tokens: 150
                });
                
                const aiResponse = completionResponse.choices[0].message;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                await Chats.create({
                    role: 'user',
                    text: message,
                    token: token || 0
                });

                await Chats.create({
                    role: 'assistant',
                    text: aiResponse.content,
                    token: token || 0
                });
                
                console.log('\n‚úÖ –ó–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–æ—Ç–∞–Ω —É—Å–ø–µ—à–Ω–æ');
                return {
                    message: aiResponse.content,
                    searchResults: null
                };
            }
            
            // –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –æ –ø–æ–º–æ—â–∏ –≤ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞
            if (requestAnalysis.requestType === "writing_help") {
                console.log(`üìù –û–±–Ω–∞—Ä—É–∂–µ–Ω –∑–∞–ø—Ä–æ—Å –æ –ø–æ–º–æ—â–∏ –≤ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏, –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é`);
                
                // –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ–º–æ—â–∏ –≤ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏
                let systemPromptContent = `–¢—ã - –±–∏–±–ª–∏–æ—Ç–µ—á–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –ø–æ–º–æ—â–∏ –≤ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –Ω–∞–ø—Ä–∞–≤–∏—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä –≤ —Å—Ç–æ—Ä–æ–Ω—É –ø–æ–∏—Å–∫–∞ –ø–æ–ª–µ–∑–Ω—ã—Ö –∫–Ω–∏–≥ –∏–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.

–ü—Ä–∞–≤–∏–ª–∞ –æ—Ç–≤–µ—Ç–∞:
1. –ù–µ –ø–∏—à–∏ –¥–ª–∏–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é —Ç–µ–∫—Å—Ç–æ–≤
2. –ù–µ —Å–æ—Å—Ç–∞–≤–ª—è–π –ø–ª–∞–Ω—ã –∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ä–∞–±–æ—Ç
3. –ü—Ä–µ–¥–ª–æ–∂–∏ –Ω–∞–π—Ç–∏ –∫–Ω–∏–≥–∏ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ —Ç–µ–º–µ –∑–∞–ø—Ä–æ—Å–∞
4. –°–ø—Ä–æ—Å–∏, –∫–∞–∫–∏–µ –∏–º–µ–Ω–Ω–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω—É–∂–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é 
5. –ë—É–¥—å –∫—Ä–∞—Ç–æ–∫ –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–µ–Ω

–ü—Ä–∏–º–µ—Ä —Ö–æ—Ä–æ—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞:
"–Ø –º–æ–≥—É –ø–æ–º–æ—á—å –Ω–∞–π—Ç–∏ –ø–æ–ª–µ–∑–Ω—ã–µ –∫–Ω–∏–≥–∏ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ. –ö–∞–∫–∏–µ –∏–º–µ–Ω–Ω–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤–∞–º –Ω—É–∂–Ω—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã?"

–ü—Ä–∏–º–µ—Ä –ø–ª–æ—Ö–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:
"–î–ª—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è —ç—Å—Å–µ –≤–∞–º –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–µ: 1. –°–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω... 2. –ù–∞–ø–∏—Å–∞—Ç—å –≤–≤–µ–¥–µ–Ω–∏–µ... 3. –†–∞—Å–∫—Ä—ã—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é —á–∞—Å—Ç—å..."

–ì–æ–≤–æ—Ä–∏ –ø—Ä–æ—Å—Ç–æ, –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫. –û–ø—Ä–µ–¥–µ–ª–∏ —Ç–µ–º—É –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –ø–æ–∏—Å–∫–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø–æ –Ω–µ–π. –ü—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–º–æ—â—å –≤ –ø–æ–¥–±–æ—Ä–µ –∫–Ω–∏–≥.`;
                
                const completionResponse = await this.openai.chat.completions.create({
                    model: "gpt-4o-mini",
                    messages: [
                        { role: "system", content: systemPromptContent },
                        ...context,
                        { role: 'user', content: message }
                    ],
                    temperature: 0.7,
                    max_tokens: 150
                });
                
                const aiResponse = completionResponse.choices[0].message;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                await Chats.create({
                    role: 'user',
                    text: message,
                    token: token || 0
                });

                await Chats.create({
                    role: 'assistant',
                    text: aiResponse.content,
                    token: token || 0
                });
                
                console.log('\n‚úÖ –ó–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–æ—Ç–∞–Ω —É—Å–ø–µ—à–Ω–æ');
                return {
                    message: aiResponse.content,
                    searchResults: null
                };
            }

            // –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –æ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ
            if (requestAnalysis.requestType === "library_info") {
                console.log(`üìö –û–±–Ω–∞—Ä—É–∂–µ–Ω –∑–∞–ø—Ä–æ—Å –æ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é`);
                
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ
                const libraryInfoParams = requestAnalysis.suggestedFunction.params;
                const libraryInfoResult = this.getLibraryInfo(libraryInfoParams);
                
                console.log('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ:', libraryInfoResult);
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –æ—Ç–≤–µ—Ç–∞
                let systemPromptContent = `–¢—ã - –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –†–µ—Å–ø—É–±–ª–∏–∫–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω.
                    
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ. –û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
–ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ–ø–æ–ª–Ω–∞—è, —Å–∫–∞–∂–∏, —á—Ç–æ —É —Ç–µ–±—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏–ª–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

–ì–æ–≤–æ—Ä–∏ –Ω–∞ —Ç–æ–º –∂–µ —è–∑—ã–∫–µ, —á—Ç–æ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (—Ä—É—Å—Å–∫–∏–π –∏–ª–∏ –∫–∞–∑–∞—Ö—Å–∫–∏–π).`;
                
                const completionResponse = await this.openai.chat.completions.create({
                    model: "gpt-4o-mini",
                    messages: [
                        { role: "system", content: systemPromptContent },
                        ...context,
                        { role: 'user', content: message },
                        { 
                            role: 'function', 
                            name: 'getLibraryInfo',
                            content: JSON.stringify(libraryInfoResult)
                        }
                    ],
                    temperature: 0.7,
                    max_tokens: 500
                });
                
                const aiResponse = completionResponse.choices[0].message;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                await Chats.create({
                    role: 'user',
                    text: message,
                    token: token || 0
                });

                await Chats.create({
                    role: 'assistant',
                    text: aiResponse.content,
                    token: token || 0
                });
                
                console.log('\n‚úÖ –ó–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–æ—Ç–∞–Ω —É—Å–ø–µ—à–Ω–æ');
                return {
                    message: aiResponse.content,
                    searchResults: null
                };
            }

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ GPT –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–Ω–∏–≥
            const completion = await this.openai.chat.completions.create({
                model: "gpt-4o-mini",
                messages: [
                    this.systemPrompt,
                    ...context,
                    { role: 'user', content: message }
                ],
                functions: [
                    {
                        name: "searchBooks",
                        description: "Search for books by author, title or general query",
                        parameters: {
                            type: "object",
                            properties: {
                                author: { type: "string", description: "Author name" },
                                title: { type: "string", description: "Book title" },
                                query: { type: "string", description: "General search query" }
                            }
                        }
                    }
                ],
                // –ü–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–µ–ª–∏, –∫–∞–∫—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–ø—Ä–æ—Å–∞
                function_call: requestAnalysis && requestAnalysis.suggestedFunction ? 
                               {name: requestAnalysis.suggestedFunction.name} : "auto"
            });

            const aiResponse = completion.choices[0].message;
            console.log('\nü§ñ –û—Ç–≤–µ—Ç GPT:');
            console.log('   –ö–æ–Ω—Ç–µ–Ω—Ç:', aiResponse.content || '[–ù–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞, —Ç–æ–ª—å–∫–æ –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏]');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–µ—à–∏–ª –ª–∏ AI –∏—Å–∫–∞—Ç—å –∫–Ω–∏–≥–∏
            let searchResults = null;
            
            if (aiResponse.function_call && aiResponse.function_call.name === 'searchBooks') {
                const searchParams = JSON.parse(aiResponse.function_call.arguments);
                console.log('üìä –ò—Å—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞:', searchParams);
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–∞–ø—Ä–æ—Å, –¥–æ–±–∞–≤–ª—è—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–µ–≥–∏—Å—Ç—Ä
                if (searchParams.query) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
                    const originalQuery = searchParams.query;
                    
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –≤–∞—Ä–∏–∞–Ω—Ç —Å –∑–∞–≥–ª–∞–≤–Ω—ã–º–∏ –ø–µ—Ä–≤—ã–º–∏ –±—É–∫–≤–∞–º–∏
                    const words = searchParams.query.split(' ');
                    const capitalizedWords = words.map(word => 
                        word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                    );
                    const capitalizedQuery = capitalizedWords.join(' ');
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—Ä–∏–∞–Ω—Ç —Å –∑–∞–≥–ª–∞–≤–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏
                    searchParams.query = capitalizedQuery;
                    
                    console.log('üìä –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', originalQuery);
                    console.log('üìä –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å:', capitalizedQuery);
                }
                
                // –¢–∞–∫–∂–µ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∞–≤—Ç–æ—Ä–∞, –µ—Å–ª–∏ –æ–Ω —É–∫–∞–∑–∞–Ω
                if (searchParams.author) {
                    const words = searchParams.author.split(' ');
                    const capitalizedWords = words.map(word => 
                        word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                    );
                    searchParams.author = capitalizedWords.join(' ');
                    
                    console.log('üìä –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω—ã–π –∞–≤—Ç–æ—Ä:', searchParams.author);
                }
                
                console.log('\nüìö –ü–µ—Ä–µ–¥–∞–µ–º –∑–∞–ø—Ä–æ—Å –≤ BookController...');
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º BookController –¥–ª—è –ø–æ–∏—Å–∫–∞
                const mockReq = { body: searchParams };
                const mockRes = {
                    json: (data) => {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞
                        searchResults = {
                            books: data.books || [],
                            sources: data.sources || { description: [], udc: [] }
                        };
                        
                        const booksCount = searchResults.books?.length || 0;
                        console.log(`üîé BookController –≤–µ—Ä–Ω—É–ª ${booksCount} –∫–Ω–∏–≥`);
                        
                        if (booksCount > 0) {
                            console.log('   –ü–µ—Ä–≤—ã–µ 3 –∫–Ω–∏–≥–∏:');
                            searchResults.books.slice(0, 3).forEach((book, i) => {
                                console.log(`     ${i+1}. "${book.TITLE}" - ${book.AUTHOR}`);
                            });
                        } else {
                            console.log('   ‚ùå –ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                        }
                    }
                };

                console.time('‚è±Ô∏è –í—Ä–µ–º—è –ø–æ–∏—Å–∫–∞');
                await BookController.searchBooks(mockReq, mockRes);
                console.timeEnd('‚è±Ô∏è –í—Ä–µ–º—è –ø–æ–∏—Å–∫–∞');
                
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –∫–Ω–∏–≥–∏ —Å –∑–∞–≥–ª–∞–≤–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏, –ø–æ–ø—Ä–æ–±—É–µ–º —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
                if (searchParams.query && (!searchResults.books || searchResults.books.length === 0)) {
                    console.log('üìö –ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å...');
                    
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º (–≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ)
                    const alternativeReq = { 
                        body: { 
                            ...searchParams,
                            query: searchParams.query.toLowerCase()
                        } 
                    };
                    
                    console.log('üìä –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å:', alternativeReq.body.query);
                    
                    // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫ –µ—â–µ —Ä–∞–∑
                    console.time('‚è±Ô∏è –í—Ä–µ–º—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞');
                    await BookController.searchBooks(alternativeReq, mockRes);
                    console.timeEnd('‚è±Ô∏è –í—Ä–µ–º—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞');
                }
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ –≤ GPT
                console.log('\nüß† –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ –≤ GPT...');
                
                // –í—ã–±–∏—Ä–∞–µ–º –∫–Ω–∏–≥–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                const booksToSend = searchResults.sources && searchResults.sources.description && 
                                  searchResults.sources.description.length > 0 ? 
                                  searchResults.sources.description : searchResults.books;
                
                console.log(`üìö –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ${booksToSend.length} –∫–Ω–∏–≥ –≤ GPT`);
                
                const finalResponse = await this.openai.chat.completions.create({
                    model: "gpt-4o-mini",
                    messages: [
                        {
                            role: "system",
                            content: `–¢—ã - –±–∏–±–ª–∏–æ—Ç–µ—á–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–æ–æ–±—â–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –∫–Ω–∏–≥ –ø–æ–Ω—è—Ç–Ω–æ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ.

–í–æ—Ç –∫–Ω–∏–≥–∏, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

–í–ê–ñ–ù–û:
‚Ä¢ –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –Ω–∞–∑–≤–∞–Ω–∏–µ, –∞–≤—Ç–æ—Ä–∞ –∏ BR_ID –¥–ª—è –∫–∞–∂–¥–æ–π –∫–Ω–∏–≥–∏
‚Ä¢ –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –±–æ–ª–µ–µ 5 –∫–Ω–∏–≥, –ø–æ–∫–∞–∂–∏ —Ç–æ–ª—å–∫–æ 5 –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö
‚Ä¢ –ï—Å–ª–∏ –∫–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, —Å–æ–æ–±—â–∏ –æ–± —ç—Ç–æ–º –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —É—Ç–æ—á–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
‚Ä¢ –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ç–æ–º –∂–µ —è–∑—ã–∫–µ, —á—Ç–æ –∏ –∑–∞–ø—Ä–æ—Å (—Ä—É—Å—Å–∫–∏–π –∏–ª–∏ –∫–∞–∑–∞—Ö—Å–∫–∏–π)
‚Ä¢ –ü—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —É—Ç–æ—á–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å, –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –µ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è–º

–§–æ—Ä–º–∞—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∫–Ω–∏–≥:
1. "–ù–ê–ó–í–ê–ù–ò–ï" - –ê–í–¢–û–† (–ë–† ID: XXXX)
2. "–ù–ê–ó–í–ê–ù–ò–ï" - –ê–í–¢–û–† (–ë–† ID: XXXX)
...

–í –∫–æ–Ω—Ü–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–ø—Ä–æ—Å–∏, –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —ç—Ç–∏ –∫–Ω–∏–≥–∏ –∏–ª–∏ –ø–æ–º–æ—á—å —Å –¥—Ä—É–≥–∏–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏.`
                        },
                        ...context,
                        { role: 'user', content: message },
                        aiResponse,
                        {
                            role: 'function',
                            name: 'searchBooks',
                            content: JSON.stringify(booksToSend || [])
                        }
                    ]
                });

                aiResponse.content = finalResponse.choices[0].message.content;
                
                console.log('ü§ñ –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:', aiResponse.content);
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            await Chats.create({
                role: 'user',
                text: message,
                token: token || 0
            });

            await Chats.create({
                role: 'assistant',
                text: aiResponse.content,
                token: token || 0
            });

            console.log('\n‚úÖ –ó–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–æ—Ç–∞–Ω —É—Å–ø–µ—à–Ω–æ');
            return {
                message: aiResponse.content,
                searchResults: searchResults
            };

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –≤ —á–∞—Ç–µ:', error);
            throw error;
        }
    }
}

module.exports = new SmartLibrarian(); 